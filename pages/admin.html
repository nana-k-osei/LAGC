<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="Admin Dashboard - Love All Girls Club" />
    <title>Admin Dashboard - Love All Girls Club</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&family=Playfair+Display:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body class="font-sans bg-white">
    <!-- Top Utility Bar -->
    <div class="w-full bg-black text-white text-sm py-2">
      <div class="container mx-auto px-8 flex justify-between items-center">
        <span>Admin Dashboard</span>
        <div class="flex space-x-6">
          <a href="#" class="hover:text-orange-500">Help</a>
          <button id="admin-logout" class="hover:text-orange-500 text-red-400">
            Logout
          </button>
        </div>
      </div>
    </div>

    <!-- Navigation -->
    <nav class="bg-white border-b border-gray-200 sticky top-0 z-40">
      <div class="container mx-auto px-8 py-4 flex items-center gap-8">
        <a href="index.html">
          <img src="/assets/logos/LAG Black.png" alt="LAGC Logo" class="h-10" />
        </a>
        <h1 class="text-2xl font-bold">Admin Panel</h1>
      </div>
    </nav>

    <!-- Main Content -->
    <div class="min-h-screen bg-white py-12">
      <div class="w-full max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Admin Dashboard -->
        <div id="admin-dashboard" class="space-y-8">
          <!-- Header -->
          <div class="mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Dashboard</h1>
            <p class="text-gray-600 mt-2">Manage discounts and member access</p>
          </div>

          <!-- Discount Management Card -->
          <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div
              class="bg-gradient-to-r from-green-500 to-emerald-600 px-8 py-6"
            >
              <h2 class="text-2xl font-bold text-white">
                ðŸ’° Discount Management
              </h2>
            </div>

            <div class="p-8">
              <!-- Current Discount Display -->
              <div
                class="mb-8 p-6 bg-gradient-to-r from-orange-50 to-orange-100 rounded-lg border border-orange-200"
              >
                <p
                  class="text-sm text-gray-700 font-semibold uppercase tracking-wide"
                >
                  Current Global Discount
                </p>
                <p
                  id="current-discount-display"
                  class="text-6xl font-bold text-orange-600 mt-3"
                >
                  0%
                </p>
                <p class="text-sm text-gray-600 mt-3">
                  âœ… Applied to all active members automatically
                </p>
              </div>

              <!-- Set New Discount Form -->
              <div class="space-y-4">
                <div>
                  <label
                    class="block text-sm font-bold text-gray-800 uppercase mb-3"
                  >
                    Set New Discount (%)
                  </label>
                  <div class="flex gap-3">
                    <input
                      type="number"
                      id="discount-input"
                      min="0"
                      max="100"
                      placeholder="Enter discount percentage (0-100)"
                      class="flex-1 px-4 py-3 border-2 border-gray-300 rounded-lg focus:outline-none focus:border-green-500 focus:ring-2 focus:ring-green-200 text-lg font-semibold"
                    />
                    <button
                      id="update-discount-btn"
                      class="px-8 py-3 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition flex items-center gap-2 whitespace-nowrap"
                    >
                      <span id="btn-text">Update</span>
                      <span id="btn-loader" class="hidden">
                        <svg
                          class="animate-spin h-5 w-5 text-white"
                          xmlns="http://www.w3.org/2000/svg"
                          fill="none"
                          viewBox="0 0 24 24"
                        >
                          <circle
                            class="opacity-25"
                            cx="12"
                            cy="12"
                            r="10"
                            stroke="currentColor"
                            stroke-width="4"
                          ></circle>
                          <path
                            class="opacity-75"
                            fill="currentColor"
                            d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"
                          ></path>
                        </svg>
                      </span>
                    </button>
                  </div>
                  <p class="text-xs text-gray-500 mt-2">
                    ðŸ’¡ Members will see this discount automatically applied at
                    checkout
                  </p>
                </div>

                <!-- Status Messages -->
                <div
                  id="success-msg"
                  class="hidden p-4 bg-green-50 border border-green-200 text-green-700 rounded-lg text-sm font-semibold"
                ></div>
                <div
                  id="error-msg"
                  class="hidden p-4 bg-red-50 border border-red-200 text-red-700 rounded-lg text-sm font-semibold"
                ></div>
              </div>
            </div>
          </div>

          <!-- Members Management -->
          <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div class="bg-gradient-to-r from-blue-500 to-blue-600 px-8 py-6">
              <h3 class="text-2xl font-bold text-white">
                ðŸ‘¥ Members Management
              </h3>
            </div>

            <div class="p-8">
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead>
                    <tr class="bg-gray-50 border-b-2 border-gray-200">
                      <th
                        class="px-6 py-3 text-left text-sm font-bold text-gray-700"
                      >
                        Name
                      </th>
                      <th
                        class="px-6 py-3 text-left text-sm font-bold text-gray-700"
                      >
                        Email
                      </th>
                      <th
                        class="px-6 py-3 text-left text-sm font-bold text-gray-700"
                      >
                        Member Since
                      </th>
                      <th
                        class="px-6 py-3 text-left text-sm font-bold text-gray-700"
                      >
                        Status
                      </th>
                      <th
                        class="px-6 py-3 text-left text-sm font-bold text-gray-700"
                      >
                        Actions
                      </th>
                    </tr>
                  </thead>
                  <tbody id="members-table-body">
                    <tr>
                      <td
                        colspan="5"
                        class="px-6 py-8 text-center text-gray-500"
                      >
                        Loading members...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- Discount History -->
          <div class="bg-white rounded-xl shadow-md overflow-hidden">
            <div
              class="bg-gradient-to-r from-purple-500 to-purple-600 px-8 py-6"
            >
              <h3 class="text-2xl font-bold text-white">ðŸ“Š Discount History</h3>
            </div>

            <div class="p-8">
              <div class="overflow-x-auto">
                <table class="w-full">
                  <thead>
                    <tr class="bg-gray-50 border-b-2 border-gray-200">
                      <th
                        class="px-6 py-3 text-left text-sm font-bold text-gray-700"
                      >
                        Date & Time
                      </th>
                      <th
                        class="px-6 py-3 text-left text-sm font-bold text-gray-700"
                      >
                        Discount %
                      </th>
                      <th
                        class="px-6 py-3 text-left text-sm font-bold text-gray-700"
                      >
                        Previous %
                      </th>
                      <th
                        class="px-6 py-3 text-left text-sm font-bold text-gray-700"
                      >
                        Changed By
                      </th>
                    </tr>
                  </thead>
                  <tbody id="history-table-body">
                    <tr>
                      <td
                        colspan="4"
                        class="px-6 py-8 text-center text-gray-500"
                      >
                        Loading history...
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Account Management Script -->
    <script type="module">
      import Authentication from "/javascript/ui/authentication.js";
      import DiscountManager from "/javascript/ui/discountManager.js";

      // Flag to track if we've already done the auth check
      let authCheckDone = false;

      // Check if user is logged in and is admin
      const checkAuth = async () => {
        if (authCheckDone) return;
        authCheckDone = true;

        console.log("=== ADMIN AUTH CHECK START ===");

        // Wait for Firebase auth state to be determined
        console.log("Step 0: Waiting for Firebase auth to be ready...");
        const ready = await Authentication.waitForAuthReady();
        if (!ready) {
          console.log("âŒ Auth never became ready - timing out");
          window.location.href = "/pages/membership.html";
          return false;
        }

        console.log("Step 1: Check if currentUser exists");
        console.log("currentUser:", Authentication.currentUser?.email);

        // Check 1: Is user logged in?
        if (!Authentication.currentUser) {
          console.log("âŒ No currentUser - redirecting to membership");
          window.location.href = "/pages/membership.html";
          return false;
        }

        console.log("âœ… User is logged in");
        console.log("Step 2: Verify membership data is loaded");

        console.log("membershipData:", Authentication.membershipData);

        console.log("Step 3: Check isAdmin status");
        const adminStatus = Authentication.isAdmin();
        console.log("isAdmin() returned:", adminStatus);
        console.log(
          "membershipData.isAdmin value:",
          Authentication.membershipData?.isAdmin
        );
        console.log(
          "typeof membershipData.isAdmin:",
          typeof Authentication.membershipData?.isAdmin
        );

        // Check 3: Is user admin?
        if (!adminStatus) {
          console.log("âŒ User is NOT admin - redirecting to index");
          console.log("isAdmin debug:", {
            hasMembershipData: !!Authentication.membershipData,
            isAdminValue: Authentication.membershipData?.isAdmin,
            strictEqual: Authentication.membershipData?.isAdmin === true,
          });
          window.location.href = "/pages/index.html";
          return false;
        }

        console.log("âœ… User IS admin - showing dashboard");
        console.log("=== ADMIN AUTH CHECK PASSED ===");
        return true;
      };

      // Handle logout
      document
        .getElementById("admin-logout")
        .addEventListener("click", async () => {
          await Authentication.signOut();
          window.location.href = "/pages/membership.html";
        });

      // Initialize on load
      document.addEventListener("DOMContentLoaded", async () => {
        console.log("DOMContentLoaded fired");
        if (await checkAuth()) {
          console.log("Auth check passed, initializing dashboard...");
          try {
            await DiscountManager.initialize();
            await loadMembers();
            updateUI();
            setupEventListeners();
            console.log("Dashboard initialized successfully");
          } catch (error) {
            console.error("Error initializing dashboard:", error);
          }
        }

        // Watch for auth changes
        Authentication.onUserLoggedIn = function (user) {
          console.log("onUserLoggedIn fired for:", user.email);
          checkAuth();
        };

        Authentication.onUserLoggedOut = function () {
          console.log("onUserLoggedOut fired");
          checkAuth();
        };
      });

      // Load and display all members
      const loadMembers = async () => {
        try {
          const members = await Authentication.getAllMembers();
          const tbody = document.getElementById("members-table-body");

          if (!members || members.length === 0) {
            tbody.innerHTML =
              '<tr><td colspan="5" class="px-4 py-6 text-center text-gray-500">No members yet</td></tr>';
            return;
          }

          tbody.innerHTML = members
            .map((member) => {
              // Use joinDate if available, fallback to createdAt
              const dateString = member.joinDate || member.createdAt;
              let memberDate = "N/A";
              if (dateString) {
                const date = new Date(dateString);
                memberDate = !isNaN(date.getTime())
                  ? date.toLocaleDateString()
                  : "Invalid Date";
              }
              const isAdmin = member.isAdmin ? "Yes" : "No";
              return `
            <tr class="border-b border-gray-100 hover:bg-gray-50 transition">
              <td class="px-6 py-4 text-sm font-medium text-gray-900">${
                member.fullName || "N/A"
              }</td>
              <td class="px-6 py-4 text-sm text-gray-700">${member.email}</td>
              <td class="px-6 py-4 text-sm text-gray-600">${memberDate}</td>
              <td class="px-6 py-4 text-sm">
                <span class="inline-flex items-center px-3 py-1 rounded-full text-xs font-semibold ${
                  member.isAdmin
                    ? "bg-orange-100 text-orange-800"
                    : "bg-green-100 text-green-800"
                }">
                  ${member.isAdmin ? "ðŸ‘‘ Admin" : "âœ“ Member"}
                </span>
              </td>
              <td class="px-6 py-4 text-sm">
                <button onclick="toggleAdminStatus('${
                  member.id
                }', ${!member.isAdmin})" class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition text-xs font-bold">
                  ${member.isAdmin ? "Remove Admin" : "Make Admin"}
                </button>
              </td>
            </tr>
          `;
            })
            .join("");
        } catch (error) {
          console.error("Error loading members:", error);
          const tbody = document.getElementById("members-table-body");
          tbody.innerHTML =
            '<tr><td colspan="5" class="px-4 py-6 text-center text-red-500">Error loading members</td></tr>';
        }
      };

      // Toggle admin status for a member
      window.toggleAdminStatus = async (memberId, makeAdmin) => {
        try {
          const result = await Authentication.setAdminStatus(
            memberId,
            makeAdmin
          );
          if (result.success) {
            await loadMembers();
            showSuccess(
              `âœ… Member ${makeAdmin ? "promoted to" : "removed from"} admin!`,
              document.getElementById("success-msg")
            );
          } else {
            showError(result.error, document.getElementById("error-msg"));
          }
        } catch (error) {
          showError(
            "Error: " + error.message,
            document.getElementById("error-msg")
          );
        }
      };

      // Update UI with current discount
      const updateUI = () => {
        const currentDiscount = DiscountManager.getGlobalDiscount();
        document.getElementById("current-discount-display").textContent =
          currentDiscount + "%";

        const history = DiscountManager.getDiscountHistory();
        const tbody = document.getElementById("history-table-body");

        if (history.length === 0) {
          tbody.innerHTML =
            '<tr><td colspan="4" class="px-4 py-6 text-center text-gray-500">No discount history yet</td></tr>';
        } else {
          tbody.innerHTML = history
            .reverse()
            .map(
              (record) => `
            <tr class="border-b border-gray-100 hover:bg-gray-50 transition">
              <td class="px-6 py-4 text-sm text-gray-700">${record.timestamp}</td>
              <td class="px-6 py-4 text-sm font-bold text-green-600">${record.percentage}%</td>
              <td class="px-6 py-4 text-sm text-gray-600">${record.previousPercentage}%</td>
              <td class="px-6 py-4 text-sm text-gray-600">${record.setBy}</td>
            </tr>
          `
            )
            .join("");
        }
      };

      // Setup event listeners
      const setupEventListeners = () => {
        const updateBtn = document.getElementById("update-discount-btn");
        const discountInput = document.getElementById("discount-input");
        const successMsg = document.getElementById("success-msg");
        const errorMsg = document.getElementById("error-msg");
        const btnText = document.getElementById("btn-text");
        const btnLoader = document.getElementById("btn-loader");

        updateBtn.addEventListener("click", async () => {
          const value = parseInt(discountInput.value);

          // Validation
          if (isNaN(value)) {
            showError("Please enter a valid number", errorMsg);
            return;
          }

          if (value < 0 || value > 100) {
            showError("Discount must be between 0 and 100", errorMsg);
            return;
          }

          // Show loader
          updateBtn.disabled = true;
          btnText.classList.add("hidden");
          btnLoader.classList.remove("hidden");
          successMsg.classList.add("hidden");
          errorMsg.classList.add("hidden");

          try {
            const result = await DiscountManager.setGlobalDiscount(value);

            // Hide loader
            updateBtn.disabled = false;
            btnText.classList.remove("hidden");
            btnLoader.classList.add("hidden");

            if (result.success) {
              showSuccess(
                `âœ… Discount updated to ${value}% and applied to all active members!`,
                successMsg
              );
              discountInput.value = "";
              updateUI();
            } else {
              showError(result.error, errorMsg);
            }
          } catch (error) {
            updateBtn.disabled = false;
            btnText.classList.remove("hidden");
            btnLoader.classList.add("hidden");
            showError("Error: " + error.message, errorMsg);
          }
        });

        // Allow Enter key to submit
        discountInput.addEventListener("keypress", (e) => {
          if (e.key === "Enter") {
            updateBtn.click();
          }
        });
      };

      const showSuccess = (message, element) => {
        element.textContent = message;
        element.classList.remove("hidden");
      };

      const showError = (message, element) => {
        element.textContent = message;
        element.classList.remove("hidden");
      };
    </script>
  </body>
</html>
